/**
 * Auto-detect new SODA lottery datasets on data.ny.gov
 *
 * Run: npx tsx scripts/check-new-datasets.ts
 *
 * Queries the SODA API catalog for lottery-related datasets and compares
 * against known dataset IDs. If new datasets are found, creates a GitHub
 * Issue (when running in CI with GITHUB_TOKEN) or logs to console.
 */

import fs from 'fs';
import path from 'path';

const KNOWN_DATASETS: Record<string, string> = {
  'd6yy-54nr': 'Powerball',
  '5xaw-6ayf': 'Mega Millions',
  'kwxv-fwze': 'Cash4Life',
  '6nbc-h7bj': 'NY Lotto',
  'dg63-4siq': 'Take 5',
};

const LOTTERY_SEARCH_TERMS = ['lottery', 'lotto', 'winning numbers', 'draw', 'jackpot', 'mega', 'powerball'];

interface SodaCatalogEntry {
  resource: {
    id: string;
    name: string;
    description?: string;
    updatedAt?: string;
  };
  metadata?: {
    domain?: string;
  };
}

async function searchSodaCatalog(): Promise<SodaCatalogEntry[]> {
  const results: SodaCatalogEntry[] = [];

  for (const term of LOTTERY_SEARCH_TERMS) {
    try {
      const url = `https://api.us.socrata.com/api/catalog/v1?domains=data.ny.gov&search_context=data.ny.gov&q=${encodeURIComponent(term)}&limit=50`;
      const response = await fetch(url);
      if (!response.ok) continue;

      const data = await response.json();
      if (data.results) {
        results.push(...data.results);
      }
    } catch {
      // Skip on error
    }
  }

  // Deduplicate by resource ID
  const seen = new Set<string>();
  return results.filter(r => {
    if (!r.resource?.id || seen.has(r.resource.id)) return false;
    seen.add(r.resource.id);
    return true;
  });
}

async function createGitHubIssue(title: string, body: string): Promise<void> {
  const token = process.env.GITHUB_TOKEN;
  const repo = process.env.GITHUB_REPOSITORY;

  if (!token || !repo) {
    console.log('GITHUB_TOKEN or GITHUB_REPOSITORY not set. Logging instead of creating issue.');
    console.log(`\n--- ISSUE ---\nTitle: ${title}\nBody:\n${body}\n`);
    return;
  }

  const response = await fetch(`https://api.github.com/repos/${repo}/issues`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      title,
      body,
      labels: ['automation', 'new-dataset'],
    }),
  });

  if (response.ok) {
    const issue = await response.json();
    console.log(`Created GitHub Issue #${issue.number}: ${title}`);
  } else {
    console.error(`Failed to create issue: ${response.status}`);
    console.log(`Title: ${title}\nBody:\n${body}`);
  }
}

async function main() {
  console.log('Checking for new SODA lottery datasets...');

  const catalogEntries = await searchSodaCatalog();
  console.log(`Found ${catalogEntries.length} lottery-related datasets on data.ny.gov`);

  const newDatasets = catalogEntries.filter(entry => {
    const id = entry.resource.id;
    return !KNOWN_DATASETS[id];
  });

  // Filter to only datasets that look like they contain winning numbers
  const relevantNew = newDatasets.filter(entry => {
    const name = (entry.resource.name || '').toLowerCase();
    const desc = (entry.resource.description || '').toLowerCase();
    const combined = `${name} ${desc}`;
    return (
      combined.includes('winning') ||
      combined.includes('lottery') ||
      combined.includes('lotto') ||
      combined.includes('draw') ||
      combined.includes('numbers')
    );
  });

  if (relevantNew.length === 0) {
    console.log('No new lottery datasets found.');
    return;
  }

  console.log(`\nFound ${relevantNew.length} potentially new lottery datasets:`);
  for (const entry of relevantNew) {
    console.log(`  - ${entry.resource.name} (ID: ${entry.resource.id})`);
  }

  const issueBody = `## New Lottery Datasets Detected

The automated dataset scanner found ${relevantNew.length} new lottery-related dataset(s) on data.ny.gov that are not currently tracked:

${relevantNew.map(e => `### ${e.resource.name}
- **Dataset ID:** \`${e.resource.id}\`
- **Description:** ${e.resource.description || 'N/A'}
- **API URL:** \`https://data.ny.gov/resource/${e.resource.id}.json\`
- **Last Updated:** ${e.resource.updatedAt || 'Unknown'}
`).join('\n')}

### Action Needed
1. Check if any of these are new lottery games (e.g., Millionaire for Life)
2. If relevant, add to \`scripts/update-data.ts\` sources and \`src/lib/lotteries/config.ts\`
3. Update CLAUDE.md known dataset IDs

*This issue was auto-generated by \`scripts/check-new-datasets.ts\`*`;

  await createGitHubIssue(
    `[Auto] ${relevantNew.length} new lottery dataset(s) detected`,
    issueBody
  );
}

main().catch(console.error);
